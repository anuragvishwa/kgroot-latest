# Docker Compose Files

This folder contains all Docker Compose configurations for the Knowledge Graph system.

## Files

### `docker-compose.yml`
**Main configuration file** - Contains all core services:
- Infrastructure: Kafka, Zookeeper, Neo4j
- Processing: alerts-enricher, graph-builder (single instance)
- Monitoring: Prometheus, Grafana, Kafka UI
- API: kg-api

**Usage:**
```bash
# Start all services (single-tenant)
docker compose -f compose/docker-compose.yml up -d

# Stop all services
docker compose -f compose/docker-compose.yml down
```

### `docker-compose.multi-client.yml`
**Static multi-client configuration** - Example with hardcoded client IDs (client-a, client-b, client-c).

Use this if you want to pre-provision clients before they send data.

**Usage:**
```bash
# Deploy with predefined clients
docker compose -f compose/docker-compose.yml -f compose/docker-compose.multi-client.yml up -d
```

### `docker-compose.multi-client.generated.yml` (Auto-generated)
**Dynamic multi-client configuration** - Auto-generated based on actual client_ids found in Kafka.

Generated by running `../generate-multi-client-compose.sh`

**Usage:**
```bash
# Generate this file first
cd ..
./generate-multi-client-compose.sh

# Then deploy
docker compose -f compose/docker-compose.yml -f compose/docker-compose.multi-client.generated.yml up -d
```

## Deployment Patterns

### Single-Tenant (Default)
```bash
docker compose -f compose/docker-compose.yml up -d
```
- One graph-builder processes all messages
- Set `CLIENT_ID=` (empty) in .env to process all clients

### Multi-Tenant (Static)
```bash
docker compose -f compose/docker-compose.yml -f compose/docker-compose.multi-client.yml up -d
```
- Uses predefined client IDs: client-a, client-b, client-c
- Good for: Pre-provisioning, testing, known clients

### Multi-Tenant (Dynamic - Recommended)
```bash
# 1. Generate config from actual Kafka data
./generate-multi-client-compose.sh

# 2. Deploy
docker compose -f compose/docker-compose.yml -f compose/docker-compose.multi-client.generated.yml up -d
```
- Discovers real client IDs from Kafka
- Good for: Production, auto-scaling, dynamic clients

## Common Commands

```bash
# View running containers
docker compose -f compose/docker-compose.yml ps

# View logs for specific service
docker compose -f compose/docker-compose.yml logs -f graph-builder

# Stop specific service
docker compose -f compose/docker-compose.yml stop graph-builder

# Restart specific service
docker compose -f compose/docker-compose.yml restart graph-builder

# Remove stopped containers
docker compose -f compose/docker-compose.yml rm
```

## Port Mapping

| Service | Internal Port | External Port | Description |
|---------|---------------|---------------|-------------|
| Zookeeper | 2181 | 2181 | Kafka coordination |
| Kafka | 9092 | 9092 | Message broker |
| Kafka UI | 8080 | 7777 | Web interface |
| Neo4j HTTP | 7474 | 7474 | Browser interface |
| Neo4j Bolt | 7687 | 7687 | Database protocol |
| KG API | 8080 | 8080 | REST API |
| Grafana | 3000 | 3000 | Dashboards |
| Prometheus | 9090 | 9091 | Metrics (note: 9091 external) |
| Graph Builder | 9090 | 9090 | Single-tenant metrics |
| Graph Builder Client A | 9090 | 9091 | Multi-tenant metrics |
| Graph Builder Client B | 9090 | 9092 | Multi-tenant metrics |
| Graph Builder Client C | 9090 | 9093 | Multi-tenant metrics |

## See Also

- [../SERVICES-EXPLAINED.md](../SERVICES-EXPLAINED.md) - What each service does
- [../MULTI-TENANT-SETUP.md](../MULTI-TENANT-SETUP.md) - Multi-tenant architecture
- [../DYNAMIC-CLIENT-DISCOVERY.md](../DYNAMIC-CLIENT-DISCOVERY.md) - Auto-discovery guide
